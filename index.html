<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%=htmlWebpackPlugin.options.title %>
    </title>
</head>

<body>
    <h1 id="h">111</h1>
    <h1 id="g">get</h1>
    <script src="./src/debounce.js"></script>
    <script>

        const tokenType = {
            WHITESPACE: /\s/,
            NUMBER: /[0-9]/,
            TOKEN: /[A-Z]/i,
            STRING: '"',

            OPERATOR: /[+|-|\/|\*|&&|\|\|\=]/
        }

        function tokenizer(code) {
            let current = 0
            const token = [];
            const length = code.length;

            while (current < length) {
                const char = code[current]
                //  match '('
                if (char === '(') {
                    current++
                    token.push({
                        type: 'paren',
                        value: '('
                    })
                }
                //  match ')'
                else if (char === ')') {
                    current++
                    token.push({
                        type: 'paren',
                        value: ')'
                    })
                }
                else if (tokenType.WHITESPACE.test(char)) {
                    current++
                }
                else if (tokenType.STRING === char) {
                    let string = '';
                    while (code[++current] !== '"') {
                        string += String(code[current])
                    }
                    token.push({
                        type: 'string',
                        value: string
                    })
                }

                else if (tokenType.OPERATOR.test(char)) {
                    current++
                    token.push({
                        type: 'operator',
                        value: char
                    })
                }
                else if (tokenType.NUMBER.test(char)) {
                    let number = char
                    current++
                    while (tokenType.NUMBER.test(code[current])) {
                        number += String(code[current])
                        current++
                    }
                    token.push({
                        type: 'number',
                        value: Number(number)
                    })
                }
                else if (char && tokenType.TOKEN.test(char)) {
                    let tokenUnit = char
                    current++
                    while (code[current] && tokenType.TOKEN.test(code[current])) {
                        tokenUnit += String(code[current])
                        current++
                    }
                    token.push({
                        type: 'name',
                        value: tokenUnit
                    })
                } else {

                    current++
                    throw new Error('the char is not in ')
                }
            }

            return token
        }

        function parser(tokens) {
            let current = 0;
            function walk() {
                let token = tokens[current]
                if (token.type === 'number') {
                    current++
                    return {
                        type: "NumberLiteral",
                        value: token.value
                    }
                } else if (token.type === 'string') {
                    current++
                    return {
                        type: "StringLiteral",
                        value: token.value
                    }
                } else if (token.type === 'name') {
                    current++
                    return {
                        type: "StatementLiteral",
                        value: token.value
                    }
                }
                else if (token.type === 'operator') {
                    current++
                    return {
                        type: "OperatorLiteral",
                        value: token.value
                    }
                }
                else if (token.type === 'paren' && token.value === '(') {

                    token = tokens[++current];

                    let node = {
                        type: "CallExpression",
                        value: token.value,
                        params: []
                    }
                    token = tokens[++current];
                    while (token.type !== 'paren' || token.type === 'paren' && token.value !== ')') {
                        //  递归循环“（）“内部的代码
                        node.params?.push(walk())
                        token = tokens[current]
                    }
                    current++
                    return node
                }

                throw new TypeError(token.type)

            }
            const length = tokens.length;
            let ast = {
                type: 'Program',
                body: []
            }
            while (current < length) {
                ast.body?.push(walk())
            }
            return ast
        }

        const code = `(add 2 (subtract 4 2))`
        const token = tokenizer(code)

        let ast = parser(token)
        console.log(ast);
    </script>
</body>

</html>